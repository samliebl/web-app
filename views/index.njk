{% extends "_layouts/base.njk" %}
{% block content %}
<div></div>
<!-- Section noting the GET response -->
<section id="test-get">
    <h2>Demonstration of a <code>GET</code> API call/request</h2>
    <p>The fact this page is rendering is a demonstration of a <code>GET</code> API call.</p>
    <p>Behind the scenes, the server contains the following routing for the API calls:</p>
    <pre><code class="language-js">// Routes
app.get('/', (req, res) => {
    res.render('index.njk', wrapper); // Pass the wrapper as context
});

app.post('/submit', (req, res) => {
    const { name } = req.body;
    res.json({ message: `Hello, ${name}! This is a POST response.` });
});</code></pre>
    <p>When the user navigates to the base directory (<code>/</code>), the backend is serving a Nunjucks template to render to HTML in the browser via a GET API call.</p>
</section>
<hr>

<!-- Section to test POST request -->
<h2 id="test-post">Two Demonstrations of <code>POST</code> API call/requests</h2>
<!-- Simple POST request demonstration -->
<section id="test-post-simple">
    <h3>1: A simple <code>POST</code> API call/request</h3>
    <form id="nameForm" action="/submit" method="POST">
        <input type="text" name="name" id="nameInput" placeholder="Enter your name">
        <button type="submit">Submit</button>
    </form>
    <!-- Placeholder for displaying styled POST response -->
    <div id="responseMessage"></div>
    <!-- Placeholder for displaying raw JSON POST response -->
    <pre id="jsonResponse"></pre>
</section>
<hr>
<!-- Section to test Whisper POST request -->
<section id="test-post-whisper">
    <h3>2: A more complex <code>POST</code> request</h3>
    <form id="transcription-form" enctype="multipart/form-data">
        <label for="audio">Upload an audio file:</label>
        <input type="file" name="audio" accept="audio/*" required />
        <button type="submit">Upload and Transcribe</button>
    </form>
    <div id="transcription-result" style="display: none;">
        <h2>Transcription Result</h2>
        <p id="transcription-text"></p>
        <div>
            <a href="#" id="copy-result" onclick="copyToClipboard(event)">Copy Result</a> |
            <a id="download-link" href="#" download>Download Transcription</a>
        </div>
    </div>
    <script>
    document.getElementById('transcription-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(this);

        try {
            const response = await fetch('/transcribe', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.transcription) {
                document.getElementById('transcription-text').textContent = result.transcription;
                document.getElementById('download-link').href = `/download-transcription/${result.fileName}`;
                document.getElementById('transcription-result').style.display = 'block';
            } else {
                document.getElementById('transcription-text').textContent = 'Transcription failed. Please try again.';
                document.getElementById('transcription-result').style.display = 'block';
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('transcription-text').textContent = 'An error occurred. Please try again later.';
            document.getElementById('transcription-result').style.display = 'block';
        }
    });

    // Function to copy transcription text to clipboard
    function copyToClipboard(event) {
        event.preventDefault(); // Prevents the page from jumping to the top
        const transcriptionText = document.getElementById('transcription-text').textContent;
        navigator.clipboard.writeText(transcriptionText).catch(err => {
            console.error('Failed to copy text:', err);
        });
    }
    </script>
</section>
<hr>
<section id="client-side-javascript">
    <h2>Note on Client-Side JavaScript</h2>
    <p>Then, there’s the JavaScript working on the front end to tie it all together and improve user experience.</p>
    <p>You can find it by inspecting this page with your browser’s developer, tools, or by reviewing the code on the <a href="https://github.com/samliebl/web-app">GitHub repo</a>.</p>
</section>
<!-- Client-side JavaScript for handling AJAX requests -->
<script type="text/javascript">
// Handle POST request for form submission
document.getElementById('nameForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent default form submission

    // Get the input value
    const nameInput = document.getElementById('nameInput').value;

    // Send AJAX request to server
    fetch('/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: nameInput })
        })
        .then(response => response.json())
        .then(data => {
            // Display the POST response message in styled HTML
            document.getElementById('responseMessage').innerHTML = `
            <p>${data.message}</p>
        `;

            // Display the raw JSON POST response
            document.getElementById('jsonResponse').textContent = JSON.stringify(data, null, 2);
        })
        .catch(error => console.error('Error:', error));
});
</script>
{% endblock %}